name: Deployment

concurrency: production

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build:
    runs-on: ubuntu-latest
    environment: production  # использовать среду "production"

    steps:
      - name: "Инициализация репозитория"
        uses: actions/checkout@v3

      - name: "Заполнение переменных среды"
        run: |
          echo "MYSQL_HOST=${{ secrets.MYSQL_HOST }}" >> .env
          echo "MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}" >> .env
          echo "MYSQL_USER=${{ secrets.MYSQL_USER }}" >> .env
          echo "MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}" >> .env
          echo "MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}" >> .env
          echo "MYSQL_PORT=${{ secrets.MYSQL_PORT }}" >> .env
          echo "TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}" >> .env
          echo "TELEGRAM_ADMIN_CHAT_ID=${{ secrets.TELEGRAM_ADMIN_CHAT_ID }}" >> .env
          echo "TELEGRAM_BOT_NAME=${{ vars.TELEGRAM_BOT_NAME }}" >> .env
          echo "MAX_OF_MESSAGES_PER_DAY=${{ vars.MAX_OF_MESSAGES_PER_DAY }}" >> .env
          echo "MAX_LINE_LENGTH=${{ vars.MAX_LINE_LENGTH }}" >> .env
          echo "ENVIRONMENT=${{ vars.ENVIRONMENT }}" >> .env

      - name: "Опубликуем артефакт, чтоб забрать его в deploy"
        uses: actions/upload-artifact@v3
        with:
          name: ENV-artifact
          path: .env


  deploy:
    runs-on: ubuntu-latest
    needs: [ build ]
    environment: production  # использовать среду "production"

    steps:
      - name: "Создадим каталог проекта"
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            mkdir -p ${{ vars.PROJECT_PATH }}

      - name: "Инициализация репозитория"
        uses: actions/checkout@v3

      - name: "Заберём артефакт"
        uses: actions/download-artifact@v3
        with:
          name: ENV-artifact

      - name: "Скопируйте .env в папку проекта."
        run: cp .env ./app

      - name: "Скопируйте файлы приложения на удаленный сервер."
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          source: "./*"
          target: ${{ vars.PROJECT_PATH }}

  preparation:
    runs-on: ubuntu-latest
    needs: [ deploy ]
    steps:
      - name: "Поставим make" # Он нам нужен для сборки
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: sudo apt-get update && sudo apt-get install make -y  # Установка make на Debian

  publish:
    runs-on: ubuntu-latest
    needs: [ preparation ]
    environment: production  # использовать среду "production"
    steps:
      - name: "Поднимем docker-compose"
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            cd ${{ vars.PROJECT_PATH }}
            touch ./app/logs/deploy.log
            make update > ${{ vars.PROJECT_PATH }}/app/logs/deploy.log 2>&1
            docker-compose ps

#  test:
#    runs-on: ubuntu-latest
#    needs: [ publish ]
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v3
#
#      - name: Check error log remotely
#        uses: appleboy/ssh-action@master
#        with:
#          host: ${{ secrets.HOST }}
#          username: ${{ secrets.USERNAME }}
#          password: ${{ secrets.PASSWORD }}
#          port: ${{ secrets.PORT }}
#          script: |
#            if grep -q "All Done." ${{ vars.PROJECT_PATH }}/app/logs/deploy.log; then
#              echo "All Done. присутствует в журнале развёртывания. Всё хорошо."
#            else
#              echo "All Done. не найден в журнале ошибок. Что-то не поднялось."
#              exit 1
#            fi

  alert:
    name: Alert
    runs-on: ubuntu-latest
    needs: [ publish ]
    steps:
      - name: Send telegram message on push
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ github.actor }} создал commit:
            Commit: ${{ github.event.commits[0].message }}

            Репозиторий: ${{ github.repository }}

            Изменения: https://github.com/${{ github.repository }}/commit/${{github.sha}}